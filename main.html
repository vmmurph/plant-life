<!DOCTYPE html>
<html>
  <head>
    <title>Artificial Life</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="Tools.js"></script>
    <script src="TileWorld.js"></script>
    <script src="Organism.js"></script>
    <style>
      body { background-color: grey; }
      .buttons {
                margin-left: 15px;
                margin-bottom: 20px;
            }
  </style>
  </head>
  <body>
    <svg id="canvas" height='500' width='800'></svg>
    <br />
        <div class="buttons">
            <button onclick="t.timeStep(); update();">Step</button>
            <button id="start" onclick="startInterval()">Start</button>
            <button id="stop" onclick="stopInterval()" disabled>Stop</button>
        </div>

    <script>
      const gridWidth = 170
      const gridHeight = 80
      const tileSize = 8
      const intervalTime = 50

      var t = new TileWorld(gridWidth, gridHeight)
      t.insert(new Plant(), 0, 30)
      t.insert(new Plant(), 169, 50)

      // for (let i = 1; i < 24; i++) {
      //   t.insert(new Barrier(), 1, i)
      // }
      // for (let i = 2; i < 24; i++) {
      //   t.insert(new Barrier(), i, 1)
      // }
      

      let margin = {
        top: 20,
        right: 20,
        bottom: 20,
        left: 20
      }

      let svg = d3.select('#canvas')
      svg.attr('width', gridWidth * tileSize + margin.left + margin.right)
         .attr('height', gridHeight * tileSize + margin.top + margin.bottom)

      let width = svg.attr('width') - margin.left - margin.right
      let height = svg.attr('height') - margin.top - margin.bottom
      let g = svg.append('g').attr('transform', `translate(${margin.left}, ${margin.top})`)

      let x = d3.scaleLinear().domain([0, t.width - 1]).range([0, width])
      let y = d3.scaleLinear().domain([0, t.height - 1]).range([0, height])

      const filterOutBarriers = e => {
        if (e.obj) {
          if (e.obj.name == 'barrier')
            return false
        }
        return true
      }
      let squares = g.selectAll('rect').data(t.flatGrid.filter(filterOutBarriers))
      let squareSize = tileSize - 1

      squares.enter()
        .append('rect')
          .attr('x', d => x(d.xloc) - (squareSize / 2))
          .attr('y', d => y(d.yloc) - (squareSize / 2))
          .attr('width', squareSize)
          .attr('height', squareSize)
          .attr('stroke', 'lightgrey')
          .attr('fill', 'white')
        

      // plants
      let p = svg.append('g').attr('transform', `translate(${margin.left}, ${margin.top})`)
      const getPlantSize = d => {
        let fullSize = tileSize - 1
        return d.obj.size / 4 * fullSize
      }
      const getPlantColor = d => {
        return Tools.getHexColor(d.obj.color)
      }

      let update = () => {
        p.selectAll('rect').remove()
        let plants = p.selectAll('rect').data(t.flatGrid.filter(e => e.obj))
        plants.enter()
          .append('rect')
            .attr('x', d => x(d.xloc) - (getPlantSize(d) / 2))
            .attr('y', d => y(d.yloc) - (getPlantSize(d) / 2))
            .attr('rx', 1)
            .attr('ry', 1)
            .attr('width', getPlantSize)
            .attr('height', getPlantSize)
            .attr('fill', getPlantColor)
      }
      
      update()

      let interval
      let startInterval = () => {
          d3.select('#start').attr('disabled', true)
          d3.select('#stop').attr('disabled', null)
          interval = d3.interval(() => {
              t.timeStep()
              update()
          }, intervalTime)
      }

      let stopInterval = () => {
          d3.select('#start').attr('disabled', null)
          d3.select('#stop').attr('disabled', true)
          interval.stop()
      }
    </script>
  </body>
</html>